# CommentAI 使用指南

## 简介

CommentAI 是一款为 Typecho 博客系统设计的智能评论回复插件，通过集成主流 AI 大语言模型（阿里云通义千问、OpenAI ChatGPT、DeepSeek 等），实现评论的自动化智能回复。插件支持多种工作模式，可根据实际需求灵活配置，既能完全自动化运行，也能通过人工审核确保回复质量。

### 核心特性

- **多平台支持**：兼容阿里云百炼、OpenAI、DeepSeek 及自定义 OpenAI 兼容接口
- **灵活的工作模式**：全自动、人工审核、仅建议三种模式可选
- **上下文感知**：支持读取文章标题、摘要和父级评论，提升回复相关性
- **智能过滤**：内置敏感词过滤、频率限制、作者评论排除等机制
- **可视化管理**：提供直观的后台管理面板，实时查看和管理 AI 回复队列
- **透明化标识**：可选择性显示 AI 标识，保持与读者的透明沟通

### 适用场景

- 个人博客：减轻评论回复负担，提升读者互动体验
- 技术博客：快速响应技术问题，提供初步解答
- 内容站点：保持评论区活跃度，增强用户粘性
- 多作者博客：统一回复风格，提升专业形象

---

## 系统要求

### 环境依赖

- **Typecho 版本**：1.0+ 或更高版本
- **PHP 版本**：7.0+ 或更高版本
- **PHP 扩展**：
  - `curl`：用于 API 请求
  - `json`：用于数据处理
  - `mbstring`：用于多字节字符串处理
- **数据库**：MySQL 5.7+ / 8.0+ 或 SQLite 3.0+

### AI 服务要求

需要至少一个 AI 服务平台的 API 密钥：

- **阿里云百炼**：[https://bailian.console.aliyun.com/](https://bailian.console.aliyun.com/)
- **OpenAI**：[https://platform.openai.com/api-keys](https://platform.openai.com/api-keys)
- **DeepSeek**：[https://platform.deepseek.com/](https://platform.deepseek.com/)

---

## 安装步骤

### 1. 下载插件

将插件文件夹 `CommentAI` 上传至 Typecho 的插件目录：

```
/usr/plugins/CommentAI/
```

确保目录结构如下：

```
/usr/plugins/CommentAI/
├── Plugin.php          # 插件主文件
├── Action.php          # 动作处理器
├── AIService.php       # AI 服务接口
├── ReplyManager.php    # 回复管理器
├── panel.php           # 管理面板
├── GUIDE.md            # 使用指南
└── README.md           # 项目说明
```

### 2. 激活插件

1. 登录 Typecho 后台
2. 进入「控制台」→「插件」
3. 找到「CommentAI」插件
4. 点击「启用」按钮

插件激活后会自动创建数据库表 `typecho_comment_ai_queue`，用于存储 AI 回复队列。

### 3. 验证安装

激活成功后，在后台菜单中会出现「AI评论回复」选项，点击进入管理面板即可确认安装成功。

---

## 配置指南

### 基础配置

#### 插件开关

- **启用**：插件正常工作，处理所有符合条件的评论
- **禁用**：插件停止工作，不处理任何评论（但不会删除已有数据）

#### 回复模式

**全自动模式**
- AI 生成回复后直接发布到评论区
- 适合对 AI 回复质量有信心的场景
- 建议配合敏感词过滤使用

**人工审核模式**（推荐）
- AI 生成回复后保存到队列，需人工审核后发布
- 可在后台管理面板查看、编辑、发布或拒绝
- 适合对回复质量有较高要求的场景

**仅建议模式**
- AI 生成回复仅作为参考，不会自动发布
- 管理员可在后台查看建议内容，手动复制使用
- 适合学习 AI 回复风格或辅助人工回复

#### 管理员 UID

指定 AI 回复使用的用户身份，通常设置为博主的 UID（默认为 1）。可在数据库 `typecho_users` 表中查询具体 UID。

---

### AI 平台配置

#### 选择 AI 服务提供商

**阿里云百炼（通义千问 Qwen）**
- 国内访问速度快，稳定性高
- 支持 Qwen-Plus、Qwen-Turbo 等多个模型
- 价格相对实惠，适合中文场景

**OpenAI（ChatGPT）**
- 全球领先的 AI 模型，回复质量高
- 支持 GPT-4、GPT-3.5-Turbo 等模型
- 需要稳定的国际网络访问

**DeepSeek**
- 国产开源模型，性价比高
- 支持 DeepSeek-Chat 等模型
- 适合预算有限的场景

**自定义 OpenAI 兼容接口**
- 支持任何兼容 OpenAI API 格式的服务
- 可使用第三方代理或自建服务

#### API Key 配置

1. 在对应平台注册账号并获取 API Key
2. 将 API Key 填入配置项（必填）
3. 注意保密，避免泄露

#### API 地址（可选）

默认情况下插件会使用各平台的标准 API 地址：

- 阿里云：`https://dashscope.aliyuncs.com/compatible-mode/v1`
- OpenAI：`https://api.openai.com/v1`
- DeepSeek：`https://api.deepseek.com/v1`

如需使用代理或自定义地址，可在此处填写完整的 API Endpoint。

#### 模型名称

根据选择的平台填写对应的模型标识：

- 阿里云：`qwen-plus`、`qwen-turbo`、`qwen-max`
- OpenAI：`gpt-4o`、`gpt-4o-mini`、`gpt-3.5-turbo`
- DeepSeek：`deepseek-chat`

---

### Prompt 配置

#### 系统提示词（System Prompt）

系统提示词定义了 AI 的角色和回复风格，是影响回复质量的关键因素。

**默认提示词：**

```
你是一位友好、专业且富有人情味的博主。你的任务是根据读者的评论生成恰当的回复。

回复要求：
1. 语气自然、亲切，符合博主个人风格
2. 针对评论内容给出有价值的回应
3. 对提问要给出明确答案
4. 对赞美要表示感谢并鼓励继续交流
5. 对批评要理性对待并给出解释
6. 回复长度控制在50-150字
7. 使用中文回复（除非评论明确使用其他语言）
8. 不要使用过于正式或机械化的表达
```

**自定义建议：**

- 根据博客风格调整语气（专业、幽默、严肃等）
- 明确回复长度限制，避免过长或过短
- 强调特定领域的专业性（如技术、文学、生活等）
- 添加个性化元素（如口头禅、表情符号使用习惯等）

#### 上下文信息

勾选后，AI 会获取更多上下文信息，提升回复的相关性和准确性：

- **包含文章标题**：让 AI 了解评论所在文章的主题
- **包含文章摘要（前300字）**：提供更详细的文章内容背景
- **包含父级评论（如果是回复）**：理解对话上下文，生成连贯回复

**注意**：启用文章摘要会增加 Token 消耗，建议根据实际需求选择。

---

### 高级配置

#### 温度参数（Temperature）

控制 AI 回复的随机性和创造性：

- **0.0 - 0.3**：回复更加确定和一致，适合技术问答
- **0.4 - 0.7**：平衡创造性和准确性（推荐）
- **0.8 - 1.0**：回复更加多样和创造性，适合创意内容

默认值：`0.7`

#### 最大 Token 数

限制单次回复的最大长度：

- 中文约 1 Token = 1.5-2 个汉字
- 建议设置 200-500，对应约 100-250 字
- 过大会增加 API 费用，过小可能导致回复不完整

默认值：`300`

#### 敏感词过滤

每行填写一个敏感词，AI 生成的回复如果包含这些词将被自动拦截：

```
政治
暴力
色情
赌博
```

**建议**：根据博客内容和受众特点自定义敏感词列表。

#### 每小时最大调用次数

防止 API 费用失控的保护机制：

- 设置为 `0` 表示不限制
- 建议根据博客流量和预算设置合理值
- 超过限制后，新评论将不会触发 AI 回复

默认值：`10`

#### 回复延迟（秒）

检测到评论后延迟多少秒再回复：

- 设置为 `0` 表示立即回复
- 建议设置 30-120 秒，让回复显得更自然
- 避免过长延迟导致用户体验下降

默认值：`0`

---

### 显示设置

#### AI 标识显示

**显示 AI 标识**（推荐）
- 在回复末尾添加标识文本（如「🤖 AI辅助回复」）
- 保持与读者的透明沟通
- 符合 AI 使用的伦理规范

**不显示**
- 回复看起来与人工回复无异
- 可能引发读者对真实性的质疑
- 不建议在公开博客中使用

#### AI 标识文本

自定义显示的标识内容，默认为：`🤖 AI辅助回复`

可根据喜好修改，例如：
- `💬 由 AI 生成`
- `🤖 智能回复`
- `⚡ AI 助手`

---

### 触发条件

通过勾选以下选项，可以精确控制哪些评论会触发 AI 回复：

#### 仅对已审核的评论回复

- 勾选后，只有状态为「已审核」的评论才会触发 AI
- 避免对垃圾评论或待审核评论浪费 API 调用
- **推荐启用**

#### 忽略垃圾评论

- 自动跳过被标记为垃圾的评论
- **推荐启用**

#### 忽略引用和 Trackback

- 跳过 Pingback 和 Trackback 类型的评论
- 这类评论通常不需要回复
- **推荐启用**

#### 仅对文章的第一条评论回复

- 只对每篇文章的第一条评论生成回复
- 适合流量较大、希望控制 API 调用的场景
- 根据实际需求选择

---

## 使用流程

### 日常使用

#### 1. 读者发表评论

读者在文章下方发表评论后，插件会自动检测并处理：

1. 检查评论是否符合触发条件
2. 验证是否为管理员自己的评论（自动跳过）
3. 检查频率限制是否超标
4. 根据配置的延迟时间等待
5. 调用 AI 服务生成回复

#### 2. AI 生成回复

插件会将以下信息发送给 AI：

- 系统提示词（定义角色和风格）
- 评论内容
- 上下文信息（文章标题、摘要、父评论等）

AI 处理后返回回复内容。

#### 3. 回复处理

根据配置的回复模式：

**全自动模式**
- 通过敏感词检查后直接发布
- 包含敏感词则拦截并记录

**人工审核模式**
- 保存到队列，状态为「待审核」
- 管理员在后台查看并决定是否发布

**仅建议模式**
- 保存到队列，状态为「仅建议」
- 不会自动发布，仅供参考

---

### 后台管理

#### 访问管理面板

登录 Typecho 后台，点击左侧菜单「AI评论回复」进入管理面板。

#### 面板功能

**统计卡片**
- 实时显示各状态的回复数量
- 待审核、已发布、已拒绝、仅建议、错误、总计

**工具栏**
- **刷新**：重新加载页面数据
- **清理旧记录**：删除 30 天前的已发布和已拒绝记录
- **插件设置**：跳转到插件配置页面
- **测试连接**：测试 AI 服务是否正常

**状态筛选**
- 点击不同标签查看对应状态的回复
- 全部、待审核、已发布、已拒绝、仅建议、错误

**队列列表**
- 显示每条回复的详细信息
- 评论者、文章标题、评论内容、AI 回复、状态、时间

**操作按钮**
- **发布回复**：将 AI 回复发布到评论区（待审核/仅建议状态可用）
- **拒绝回复**：拒绝该回复，不会发布（待审核/仅建议状态可用）
- **重新生成**：重新调用 AI 生成回复（错误/已拒绝状态可用）
- **查看原评论**：跳转到评论管理页面查看原始评论

---

### 测试连接

在配置完成后，建议先测试 AI 服务连接：

1. 进入管理面板
2. 点击「测试连接」按钮
3. 插件会发送测试请求到 AI 服务
4. 成功后会显示测试回复内容
5. 失败则显示错误信息

**常见错误：**

- **API Key 无效**：检查 API Key 是否正确
- **网络连接失败**：检查服务器网络和 API 地址
- **模型不存在**：检查模型名称是否正确
- **余额不足**：检查 AI 服务账户余额

---

## 最佳实践

### 回复质量优化

#### 1. 精心设计系统提示词

系统提示词是影响回复质量的关键因素，建议：

- 明确博主的角色定位（专业、友好、幽默等）
- 详细描述回复风格和语气
- 设定回复长度范围
- 强调特定领域的专业性
- 添加个性化元素

**示例（技术博客）：**

```
你是一位经验丰富的技术博主，专注于 Web 开发和系统架构。你的任务是根据读者的评论生成专业且友好的回复。

回复要求：
1. 对技术问题给出准确、详细的解答
2. 引用相关技术文档或最佳实践
3. 语气专业但不失亲和力
4. 鼓励读者深入学习和实践
5. 回复长度控制在 80-200 字
6. 使用中文回复，技术术语保留英文
7. 适当使用代码示例（用 Markdown 格式）
```

#### 2. 合理配置上下文信息

- 技术博客：建议启用文章标题和摘要，提升回复准确性
- 生活博客：可只启用文章标题，保持回复简洁
- 对话型评论：务必启用父级评论，保持上下文连贯

#### 3. 调整温度参数

- 技术问答：0.3-0.5（更确定的回复）
- 创意内容：0.7-0.9（更多样的回复）
- 日常交流：0.5-0.7（平衡）

#### 4. 定期审查回复质量

即使使用全自动模式，也建议定期查看已发布的回复：

- 检查是否有不当内容
- 评估回复的相关性和准确性
- 根据反馈调整系统提示词
- 更新敏感词列表

---

### 成本控制

#### 1. 设置合理的频率限制

根据博客流量和预算设置每小时最大调用次数：

- 小型博客（日均 < 10 条评论）：10-20 次/小时
- 中型博客（日均 10-50 条评论）：30-50 次/小时
- 大型博客（日均 > 50 条评论）：根据预算灵活设置

#### 2. 优化上下文信息

- 文章摘要会显著增加 Token 消耗
- 如非必要，可只启用文章标题
- 根据实际效果评估是否需要摘要

#### 3. 控制回复长度

- 最大 Token 数直接影响费用
- 建议设置 200-300，满足大部分场景
- 避免设置过大导致不必要的开销

#### 4. 选择性价比高的模型

不同模型的价格差异较大：

- **阿里云 Qwen-Turbo**：性价比高，适合大量调用
- **OpenAI GPT-3.5-Turbo**：质量和价格平衡
- **DeepSeek-Chat**：价格低廉，适合预算有限场景

#### 5. 使用人工审核模式

- 避免低质量回复浪费 API 调用
- 可在发布前修改或拒绝不合适的回复
- 长期来看更经济

---

### 安全与隐私

#### 1. API Key 安全

- 不要在公开场合分享 API Key
- 定期更换 API Key
- 监控 API 使用情况，及时发现异常

#### 2. 敏感词过滤

- 根据博客内容和受众特点自定义敏感词
- 定期更新敏感词列表
- 建议启用人工审核模式作为双重保障

#### 3. 数据隐私

- 插件不会上传评论者的个人信息（如邮箱、IP）
- 仅将评论内容和文章信息发送给 AI 服务
- 建议在隐私政策中说明使用 AI 回复的情况

#### 4. 透明化原则

- 建议启用 AI 标识显示
- 在博客的隐私政策或关于页面中说明使用 AI 辅助回复
- 保持与读者的诚信沟通

---

## 故障排查

### 常见问题

#### 1. 插件激活失败

**可能原因：**
- 数据库权限不足
- 数据库类型不支持（仅支持 MySQL 和 SQLite）

**解决方案：**
- 检查数据库用户权限
- 确认数据库类型
- 查看 Typecho 错误日志

#### 2. AI 回复未生成

**可能原因：**
- 插件未启用
- 评论不符合触发条件
- 频率限制已达上限
- 评论者是管理员本人

**解决方案：**
- 检查插件配置中的「插件开关」
- 检查「触发条件」设置
- 查看「每小时最大调用次数」是否超标
- 确认评论者不是管理员

#### 3. API 调用失败

**可能原因：**
- API Key 无效或过期
- 网络连接问题
- API 地址错误
- 模型名称错误
- 账户余额不足

**解决方案：**
- 验证 API Key 是否正确
- 测试服务器网络连接
- 检查 API 地址配置
- 确认模型名称拼写
- 检查 AI 服务账户余额

#### 4. 回复质量不佳

**可能原因：**
- 系统提示词不够明确
- 温度参数设置不当
- 缺少上下文信息
- 模型选择不合适

**解决方案：**
- 优化系统提示词，增加更多细节
- 调整温度参数（降低以获得更确定的回复）
- 启用文章标题和摘要
- 尝试更高级的模型

#### 5. 回复发布失败

**可能原因：**
- 管理员 UID 配置错误
- 数据库写入权限问题
- 原评论已被删除

**解决方案：**
- 检查「管理员 UID」配置
- 验证数据库权限
- 确认原评论是否存在

---

### 日志查看

插件会在以下位置记录运行日志：

```
/usr/plugins/CommentAI/runtime.log
```

日志内容包括：

- 评论触发记录
- AI 调用请求和响应
- 错误信息和堆栈跟踪

**查看日志：**

```bash
# SSH 登录服务器后执行
tail -f /path/to/typecho/usr/plugins/CommentAI/runtime.log
```

**日志示例：**

```
[2026-01-24 21:10:42] 钩子触发 - comment类型: object
[2026-01-24 21:10:42] 处理后的commentData: {"coid":"1631","author":"xuan","text":"测试评论","status":"approved","type":"comment","parent":"0","cid":"1447"}
[2026-01-24 21:10:42] 收到评论数据: {"coid":"1631","author":"xuan","text":"测试评论"}
[2026-01-24 21:10:42] 评论信息: coid=1631, cid=1447
[2026-01-24 21:10:42] 文章信息: cid=1447, title=测试文章
```

---

## 进阶技巧

### 自定义回复风格

#### 1. 多样化的系统提示词

根据不同类型的文章使用不同的提示词：

**技术教程：**
```
你是一位技术导师，擅长将复杂概念简化。对读者的疑问给出清晰、分步骤的解答，并鼓励他们动手实践。
```

**生活随笔：**
```
你是一位善于倾听的朋友，对读者的分享给予真诚的回应，分享自己的感受和经验。
```

**产品评测：**
```
你是一位客观的评测者，对读者的问题给出基于事实的回答，帮助他们做出明智的选择。
```

#### 2. 结合文章分类

可以通过修改代码，根据文章分类动态调整系统提示词，实现更精准的回复风格。

---

### 批量管理

#### 1. 批量发布

在管理面板中，可以通过以下方式批量处理回复：

1. 筛选「待审核」状态
2. 逐条审查回复质量
3. 快速点击「发布回复」按钮

#### 2. 定期清理

建议每月执行一次「清理旧记录」操作，删除已发布和已拒绝的历史记录，保持数据库整洁。

---

### 性能优化

#### 1. 数据库索引

插件已自动创建必要的索引，无需手动优化。

#### 2. 缓存机制

如果博客流量较大，可以考虑：

- 使用 Redis 缓存 AI 回复结果
- 对相似评论使用缓存回复（需自行开发）

#### 3. 异步处理

插件已采用异步处理机制，不会阻塞评论提交流程。

---

## 更新与维护

### 版本更新

1. 备份当前插件文件和数据库
2. 下载最新版本插件
3. 覆盖旧文件（保留配置）
4. 访问后台，检查是否需要重新激活

### 数据备份

定期备份以下内容：

- 插件配置（在 Typecho 数据库的 `options` 表中）
- 回复队列数据（`typecho_comment_ai_queue` 表）
- 日志文件（`runtime.log`）

### 卸载插件

1. 在后台禁用插件
2. 删除插件文件夹
3. （可选）手动删除数据库表 `typecho_comment_ai_queue`

**注意**：卸载插件不会自动删除数据库表，如需彻底清理，请手动执行：

```sql
DROP TABLE IF EXISTS `typecho_comment_ai_queue`;
```

---

## 技术支持

### 获取帮助

- **GitHub Issues**：提交 Bug 报告或功能建议
- **文档**：查阅 README.md 和 GUIDE.md
- **日志**：查看 runtime.log 获取详细错误信息

### 贡献代码

欢迎提交 Pull Request 改进插件功能。

---

## 许可协议

本插件遵循 MIT 许可协议，可自由使用、修改和分发。

---

## 致谢

感谢以下开源项目和服务：

- Typecho 博客系统
- 阿里云百炼平台
- OpenAI API
- DeepSeek AI

---

**最后更新**：2026-01-24  
**版本**：1.0.0
