# CommentAI - Typecho AI 智能评论回复插件

<div align="center">

🤖 **让AI成为你的评论助手，自动生成高质量的回复内容**

[![Typecho](https://img.shields.io/badge/Typecho-1.2%2B-blue.svg)](http://typecho.org)
[![PHP](https://img.shields.io/badge/PHP-8.0%2B-purple.svg)](https://www.php.net/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

</div>

---

## ✨ 功能特性

- 🎯 **多种工作模式**
  - 全自动模式：AI 生成后直接发布
  - 人工审核模式：生成后需后台审核（推荐）
  - 仅建议模式：仅显示建议，不自动发布

- 🌐 **多平台AI支持**
  - ✅ 阿里云百炼（通义千问 Qwen）
  - ✅ OpenAI（ChatGPT）
  - ✅ DeepSeek
  - ✅ 自定义 OpenAI 兼容接口

- 🧠 **上下文感知**
  - 读取文章标题和摘要
  - 分析父级评论（回复场景）
  - 根据语境生成个性化回复

- 🔒 **安全防护**
  - 内置敏感词过滤
  - API 调用频率限制
  - 防止垃圾评论触发
  - 仅对已审核评论回复

- 🎨 **透明化显示**
  - 可选 AI 标识（如 🤖 AI辅助回复）
  - 符合伦理透明性原则

- 📊 **完善的管理后台**
  - 可视化审核队列
  - 一键发布/拒绝/重新生成
  - 统计数据展示
  - 批量操作支持

---

## 📋 系统要求

- Typecho 1.2.1 或 1.3+
- PHP 8.0 或更高版本
- PHP cURL 扩展
- MySQL/MariaDB/SQLite/PostgreSQL 数据库

---

## 🚀 安装步骤

### 1. 下载插件

将 `CommentAI` 文件夹上传到 Typecho 的 `usr/plugins/` 目录下。

### 2. 激活插件

进入 Typecho 后台 → 控制台 → 插件 → 找到 **CommentAI** → 点击 **启用**

### 3. 配置 AI 服务

激活后进入插件设置页面，填写以下必填项：

#### 选择 AI 平台（以阿里云百炼为例）

1. **注册阿里云账号**  
   访问 [阿里云百炼控制台](https://bailian.console.aliyun.com/)

2. **获取 API Key**  
   在控制台中创建应用并获取 API Key

3. **填写配置**
   - AI 服务提供商：选择 `阿里云百炼（通义千问 Qwen）`
   - API Key：填入你的密钥
   - 模型名称：如 `qwen-plus`（推荐）或 `qwen-turbo`（经济）

4. **点击"测试连接"**  
   确保配置正确无误

### 4. 调整回复模式

- **推荐新手**：选择 `人工审核模式`，生成后在后台审核再发布
- **信任 AI**：选择 `全自动模式`，AI 生成后直接发布
- **仅参考**：选择 `仅建议模式`，不自动发布，仅在后台查看

---

## 🔧 配置说明

### 基础配置

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| 插件开关 | 全局启用/禁用插件 | 启用 |
| 回复模式 | 全自动/人工审核/仅建议 | 人工审核 |
| 管理员UID | AI 回复以哪个用户身份发布 | 1 |

### AI 平台配置

| 配置项 | 说明 | 示例 |
|--------|------|------|
| AI 服务提供商 | 选择使用的平台 | 阿里云百炼 |
| API Key | 你的 API 密钥 | sk-xxx |
| API 地址 | 可选，留空使用默认 | - |
| 模型名称 | 具体模型标识 | qwen-plus |

**各平台默认 API 地址：**
- 阿里云：`https://dashscope.aliyuncs.com/compatible-mode/v1`
- OpenAI：`https://api.openai.com/v1`
- DeepSeek：`https://api.deepseek.com/v1`

### Prompt 配置

| 配置项 | 说明 |
|--------|------|
| 系统提示词 | 定义 AI 的角色和回复风格 |
| 上下文信息 | 勾选：文章标题/摘要/父评论 |

**Prompt 调优建议：**
- 明确你的博客风格（专业/轻松/技术/生活）
- 指定回复长度范围（建议 50-150 字）
- 强调真实性和价值（避免敷衍式回复）

### 高级配置

| 配置项 | 说明 | 推荐值 |
|--------|------|--------|
| 温度参数 | 0-1，越高越随机 | 0.7-0.9 |
| 最大Token数 | 单次回复长度限制 | 200-500 |
| 敏感词过滤 | 每行一个，匹配到则拦截 | 根据需求填写 |
| 频率限制 | 每小时最大调用次数 | 10（防止费用失控） |

### 显示设置

| 配置项 | 说明 | 推荐 |
|--------|------|------|
| AI 标识显示 | 是否在回复后显示标识 | 显示（透明化） |
| AI 标识文本 | 自定义标识内容 | 🤖 AI辅助回复 |

### 触发条件

可勾选以下条件来过滤评论：
- ✅ 仅对已审核的评论回复（**推荐勾选**）
- ✅ 忽略垃圾评论
- ✅ 忽略引用和 trackback
- ⬜ 仅对文章的第一条评论回复

---

## 📖 使用指南

### 自动回复流程

1. 读者在文章下发表评论
2. 插件检测到新评论（符合触发条件）
3. AI 读取文章上下文并生成回复
4. 根据回复模式处理：
   - **全自动**：直接发布
   - **人工审核**：保存到审核队列
   - **仅建议**：仅记录不发布

### 后台管理

进入 **控制台 → AI评论回复** 即可看到：

- **统计卡片**：待审核/已发布/已拒绝/错误等数量
- **队列列表**：所有 AI 生成的回复记录
- **操作按钮**：
  - ✅ 发布回复
  - ❌ 拒绝回复
  - 🔄 重新生成（错误时）
  - 👁️ 查看原评论

### 测试连接

在插件设置页面底部，点击后台工具栏的 **🧪 测试连接** 按钮，检查 AI 服务是否配置正确。

---

## 💡 最佳实践

### 1. Prompt 优化示例

```
你是一位热爱技术的独立开发者，经营着一个前端技术博客。
你的回复风格：
- 专业但不乏幽默
- 对新手友好，愿意解答疑问
- 乐于分享经验和资源链接
- 语气亲切，像朋友聊天

回复要求：
1. 对技术问题给出清晰的解答或思路
2. 对赞美表示感谢，鼓励继续交流
3. 对批评理性对待，虚心接受建议
4. 回复长度 50-150 字
5. 使用中文回复
6. 不要使用"感谢您的评论"等套话
```

### 2. 敏感词配置

根据你的博客内容和当地法律法规，添加需要过滤的词汇：

```
政治
暴力
色情
赌博
毒品
```

### 3. 频率限制建议

- **个人博客**：5-10 次/小时（日均 50-100 条评论）
- **流量博客**：20-50 次/小时
- **不限制**：设为 0（需注意 API 费用）

### 4. 成本控制

以阿里云 Qwen-plus 为例（2026年1月价格）：
- 输入：¥0.004/千tokens
- 输出：¥0.012/千tokens
- 单次回复约 0.01-0.03 元

**省钱技巧**：
- 使用 `qwen-turbo` 降低成本（输入¥0.003，输出¥0.006）
- 限制最大 Token 数（如 200）
- 设置合理的频率限制
- 仅对重要文章启用（通过触发条件过滤）

---

## 🛠️ 常见问题

### Q1: 评论后没有自动回复？

**排查步骤：**
1. 检查插件是否启用
2. 确认回复模式（如果是"人工审核"，需去后台发布）
3. 查看"AI评论回复"后台是否有记录
4. 检查触发条件（如"仅已审核评论"时，需先审核原评论）
5. 查看 `usr/plugins/CommentAI/runtime.log` 日志

### Q2: API 调用失败？

**可能原因：**
- API Key 错误或已过期
- API 地址填写错误
- 网络无法访问（检查服务器是否能连接外网）
- 余额不足（阿里云/OpenAI 账户）
- cURL 扩展未安装

**解决方法：**
1. 点击"测试连接"查看详细错误
2. 检查 PHP 版本和 cURL 扩展：`php -m | grep curl`
3. 如在国内服务器，OpenAI 可能需要代理

### Q3: AI 回复质量不佳？

**优化方法：**
1. 调整 System Prompt（更详细地描述你的风格）
2. 启用"包含文章标题和摘要"增强上下文
3. 提高温度参数（0.8-0.9）增加创造性
4. 更换更强大的模型（如 qwen-max、gpt-4o）

### Q4: 如何只对特定分类/文章启用？

插件暂不支持细粒度控制，可在 `Plugin.php` 的 `onCommentSubmit` 方法中添加自定义逻辑：

```php
// 仅对特定分类启用
$post = $db->fetchRow($db->select()->from($prefix . 'contents')->where('cid = ?', $commentData['cid']));
$allowedCategories = array(1, 2, 3); // 分类 ID
if (!in_array($post->mid, $allowedCategories)) {
    return; // 跳过不启用的分类
}
```

### Q5: 兼容性问题

- **Typecho 1.2.1**：完全兼容
- **Typecho 1.3+**：完全兼容
- **PHP 7.4-**：不支持（需 PHP 8.0+）
- **主题兼容**：与任何主题兼容

---

## 📊 数据库结构

插件会自动创建 `typecho_comment_ai_queue` 表：

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键 |
| cid | INT | 评论 ID |
| post_id | INT | 文章 ID |
| comment_author | VARCHAR | 评论者 |
| comment_text | TEXT | 评论内容 |
| ai_reply | TEXT | AI 生成的回复 |
| status | VARCHAR | 状态（pending/approved/rejected/published） |
| created_at | INT | 创建时间戳 |
| processed_at | INT | 处理时间戳 |
| error_msg | VARCHAR | 错误信息 |

---

## 🔄 更新日志

### v1.0.0 (2026-01-24)

- 🎉 首次发布
- ✅ 支持阿里云百炼、OpenAI、DeepSeek
- ✅ 三种工作模式（全自动/人工审核/仅建议）
- ✅ 后台可视化管理面板
- ✅ 上下文感知回复
- ✅ 敏感词过滤和频率限制
- ✅ 兼容 Typecho 1.2.1 和 1.3
- ✅ 支持 PHP 8.0+

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

### 开发计划

- [ ] 支持本地模型（Ollama）
- [ ] 多语言自动识别
- [ ] 情感分析（调整回复语气）
- [ ] 回复模板库
- [ ] 与其他插件联动（如反垃圾评论插件）
- [ ] Webhook 通知（钉钉/飞书/企业微信）

---

## 📄 开源协议

本项目采用 [MIT License](LICENSE) 开源协议。

---

## 🙏 致谢

- [Typecho](http://typecho.org/) - 优雅的轻量级博客系统
- [阿里云百炼](https://bailian.console.aliyun.com/) - 强大的 AI 平台
- [OpenAI](https://openai.com/) - 革命性的 AI 技术
- [DeepSeek](https://www.deepseek.com/) - 国产优秀 AI 模型

---

## 💬 支持

如果觉得这个插件有用，请给个 ⭐ Star 支持一下！

有问题或建议？欢迎：
- 提交 [Issue](https://github.com/yourusername/CommentAI/issues)
- 加入讨论群（QQ/Telegram/Discord）
- 通过邮件联系：your-email@example.com

---

<div align="center">

**Made with ❤️ by [Your Name]**

*让 AI 成为你的评论助手，专注于创作更好的内容！*

</div>
